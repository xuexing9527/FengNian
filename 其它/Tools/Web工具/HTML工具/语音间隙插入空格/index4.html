<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>语音逐字识别 + 停顿插空格</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  button { padding: 8px 16px; margin-right: 8px; }
  textarea { width: 100%; font-size: 16px; margin-top: 10px; }
  #finalArea { height: 200px; }
  #draftArea { height: 120px; color: #666; }
  .row { margin: 10px 0; }
</style>
</head>

<body>

<h2>语音逐字识别 + 停顿插空格（单机版）</h2>

<div class="row">
  <button id="startBtn">开始</button>
  <button id="stopBtn">停止</button>
  <button id="copyBtn">复制正式区</button>
</div>

<div class="row">
  <label>停顿插空格间隔（秒）：</label>
  <input type="number" id="pauseInterval" value="0.2" step="0.1" min="0.1" style="width:80px;">
</div>

<h3>正式区（逐字输出 + 停顿插空格）</h3>
<textarea id="finalArea" readonly></textarea>

<h3>草稿区（原始实时识别）</h3>
<textarea id="draftArea" readonly placeholder="实时识别过程展示在这里"></textarea>


<script>
(function() {

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("浏览器不支持 SpeechRecognition，请用 Chrome");
    return;
  }

  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const copyBtn = document.getElementById("copyBtn");

  const pauseIntervalInput = document.getElementById("pauseInterval");
  const finalArea = document.getElementById("finalArea");
  const draftArea = document.getElementById("draftArea");

  let recognition = null;
  let isRunning = false;

  let lastFull = "";      // 上次完整文本
  let finalText = "";     // 输出区文本

  let lastTimestamp = Date.now();   // 用于计算停顿时间

  function init() {
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = "zh-CN";

    recognition.onresult = (e) => {

      // 获取当前所有识别文本（包含 interim）
      let full = "";
      for (let i = 0; i < e.results.length; i++) {
        full += e.results[i][0].transcript;
      }

      // 草稿区（原始实时识别）
      draftArea.value = full;

      // 去掉空白
      full = full.replace(/\s+/g, "");

      // 找新增字
      let delta = "";
      if (full.length > lastFull.length) {
        delta = full.slice(lastFull.length);
      }

      // 如果有新增字，逐字加入正式区
      if (delta) {
        const now = Date.now();
        const diff = now - lastTimestamp;

        // 根据停顿插空格
        const gapSec = parseFloat(pauseIntervalInput.value);
        const gapMs = gapSec * 1000;

        if (diff >= gapMs) {
          finalText += " ";
        }

        // 逐字插空格
        finalText += delta.split("").join(" ");
        finalArea.value = finalText;

        lastTimestamp = now;
      }

      lastFull = full;
    };

    recognition.onerror = (e) => {
      console.warn("SpeechRecognition error:", e);
    };

    recognition.onend = () => {
      isRunning = false;
      startBtn.disabled = false;
    };
  }

  startBtn.onclick = () => {
    if (isRunning) return;
    init();
    recognition.start();
    isRunning = true;
    startBtn.disabled = true;

    lastFull = "";
    finalText = "";
    finalArea.value = "";
    draftArea.value = "";
    lastTimestamp = Date.now();
  };

  stopBtn.onclick = () => {
    if (!isRunning) return;
    isRunning = false;
    try { recognition.stop(); } catch (_) {}
    startBtn.disabled = false;
  };

  copyBtn.onclick = () => {
    navigator.clipboard.writeText(finalText)
      .then(()=> alert("已复制"))
      .catch(()=> alert("复制失败"));
  };

})();
</script>

</body>
</html>
